<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" name="_csrf" content="your_csrf_token_value_here">
    <title>Kmarket::main layout</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://kit.fontawesome.com/20962f3e4b.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css">
    <!--<link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="./css/product.css">-->
    <style>
        #product > .cart > form {
        }
        #product > .cart > form > table {
            width: 100%;
            border-bottom: 1px solid #d3d3d3;
            border-collapse: collapse;
            border-spacing: 0;
        }
        #product > .cart > form > table tr {
            border-bottom: 1px solid #d3d3d3;
        }
        #product > .cart > form > table th:first-child {
            width: 60px;
        }
        #product > .cart > form > table th {
            padding: 12px 0;
            border-top: 2px solid #000;
            border-bottom: 1px solid #d3d3d3;
            background: #fff;
            color: #383838;
            font-size: 0.95em;
            text-align: center;
            letter-spacing: -0.1em;
        }
        #product > .cart > form > table .empty {
            display: none;
        }
        #product > .cart > form > table td {
            text-align: center;
        }
        #product > .cart > form > table td:last-child {
            color: #ff006c;
            font-weight: bold;
        }
        #product > .cart > form > table th > input {
        }
        #product > .cart > form > table tr > td > input {
        }
        #product > .cart > form > table td > article {
            padding: 6px;
            overflow: hidden;
        }
        #product > .cart > form > table td > article > a {
            float: left;
            display: inline-block;
        }
        #product > .cart > form > table td > article > a > img {
            width: 80px;
        }

        #product > .cart > form > table td > article > div {
            float: left;
            margin-left: 10px;
        }

        #product > .cart > form > table td > article > div > h2 {
            text-align: left;
        }

        #product > .cart > form > table td > article > div > p {
            text-align: left;
            color: #777;
            margin-top: 4px;
        }

        #product > .cart > form > input[name=del] {
            border-color: #bdbdbd;
            border-bottom-color: #828282;
            background: #fafafa;
            color: #4d4d4d;
            padding: 6px 11px;
            border-width: 1px;
            margin-top: 6px;
        }

        #product > .cart > form > .total {
            float: right;
            width: 360px;
            /*height: 412px;*/
            height: 332px; /* 높이 변경 */
            padding: 20px;
            margin-top: 12px;
            background: #fff;
            border: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        #product > .cart > form > .total > h2 {
            width: 100%;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid #111;
            margin-bottom: 10px;
            padding-bottom: 10px;
            box-sizing: border-box;
            color: #1e1e1e;
        }

        #product > .cart > form > .total > table {
            width: 100%;
        }

        #product > .cart > form > .total > table tr:nth-last-child(1) td {
            font-size: 20px;
        }

        #product > .cart > form > .total > table tr:nth-last-child(1) td:last-child {
            color: #ff006c;
            font-size: 20px;
            font-weight: bold;
        }

        #product > .cart > form > .total > table td {
            padding: 10px 0;
            font-size: 14px;
            color: #555;
        }

        #product > .cart > form > .total > table td:last-child {
            text-align: right;
        }

        #product > .cart > form > .total > input[type=submit] {
            width: 100%;
            height: 56px;
            font-size: 26px;
            border-width: 1px;
            border-color: #d81818;
            border-bottom-color: #9e1212;
            background: #ed2f2f;
            background-image: -webkit-linear-gradient(#ed2f2f, #dd0e0e);
            color: #fff;
            box-sizing: border-box;
            margin-top: 10px;
        }

        /*.shift-right > article > div {
            padding-left: 10%; !* 원하는 위치로 정확하게 이동시키기 위해 이 값을 조절해 보세요. *!
        }*/

        .product-total-price {
            text-align: left;
        }

    </style>
    <script>

        function updateQuantityOnServer(itemId, quantity) {
            $.ajax({
                url: "/updateCartItemQuantity",
                type: "POST",
                data: {
                    itemId: itemId,
                    quantity: quantity
                },
                success: function (response) {
                    // 서버로부터 응답을 받아 합계를 업데이트합니다.
                    $(`#subtotal-${itemId}`).text(response.newSubtotal);

                    // 체크박스의 상태를 확인합니다.
                    const isChecked = $(`.item-checkbox[value="${itemId}"]`).is(':checked');

                    if (isChecked) {
                        // 체크된 상품의 서브 합계만 업데이트하고 전체 합계도 업데이트합니다.
                        updateTotals();
                    }
                }
            });
        }

        function updateTotals() {
            let totalItems = 0;
            let totalPrice = 0;

            $(".item-checkbox:checked").each(function() {
                const itemId = $(this).val();
                const quantity = parseFloat($(`input[data-item-id=${itemId}]`).val());
                const itemPrice = parseFloat($(`#subtotal-${itemId}`).text());

                totalItems += quantity;
                totalPrice += itemPrice;
            });

            const shippingFee = parseFloat($(".shipping-fee").text());
            const totalWithShipping = totalPrice + shippingFee;

            $(".product-total-price").text(totalPrice);
            $("#totalPrice").text(totalWithShipping);

            // 숨겨진 입력 필드에 값을 설정
            $("#hiddenTotalPrice").val(totalWithShipping);
        }
        function deleteSelectedItems() {
            var checkboxes = document.getElementsByName('selectedItems');
            var selectedItems = [];

            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    selectedItems.push(checkboxes[i].value);
                }
            }
            if (selectedItems.length > 0) {
                console.log("테스트 진행중");
                fetch('/cartItem/deleteSelected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': getCsrfToken()
                    },
                    body: JSON.stringify(selectedItems)
                })
                    .then(response => response.text())
                    .then(data => {
                        if (data === "삭제 성공") {
                            // 성공적으로 삭제된 경우 선택된 항목을 화면에서 제거합니다.
                            selectedItems.forEach(itemId => {
                                $(`tr[data-item-id="${itemId}"]`).remove();
                            });
                            // 삭제 후 합계 업데이트
                            updateTotals();
                            // 여기서 location.reload();를 제거합니다.
                        } else {
                            console.error("삭제 실패:", data);
                            alert("삭제에 실패했습니다: " + data);
                        }
                    })
                    .catch(error => {
                        console.error("오류 발생:", error);
                        alert('오류가 발생했습니다: ' + error);
                    });
            } else {
                alert('삭제할 상품을 선택해주세요.');
            }
        }        function getCsrfToken() { // JavaScript 단에 Fetch Web API 사용할때 사용하는 제이슨 속성값
            // 'X-CSRF-TOKEN': getCsrfToken() // CSRF 토큰을 헤더에 포함
            return document.querySelector('meta[name="_csrf"]').getAttribute('content');
        }

    </script>
    <script>
        $(document).ready(function () {

            updateTotals(); // 페이지 로드 시 합계 업데이트

            $('.quantity-input').on('change', function () {
                const itemId = $(this).data('item-id');
                console.log(itemId);
                const newQuantity = $(this).val();

                // AJAX 요청을 사용하여 서버에 변경된 수량 정보를 전송하십시오.
                updateQuantityOnServer(itemId, newQuantity);
            });

            $(".item-checkbox").on("change", updateTotals);



            // 전체 선택 체크박스 클릭 이벤트
            $('input[name="all"]').on('change', function () {
                if ($(this).prop('checked')) {
                    // 전체 선택 체크박스가 선택된 경우, 모든 상품 체크박스를 선택합니다.
                    $('.item-checkbox').prop('checked', true);
                } else {
                    // 전체 선택 체크박스가 선택 해제된 경우, 모든 상품 체크박스의 선택을 해제합니다.
                    $('.item-checkbox').prop('checked', false);
                }
                // 합계 업데이트 함수를 호출합니다.
                updateTotals();
            });

            // 상품별 체크박스 클릭 이벤트
            $('.item-checkbox').on('change', function () {
                if ($('.item-checkbox:checked').length === $('.item-checkbox').length) {
                    // 모든 상품 체크박스가 선택된 경우, 전체 선택 체크박스를 선택합니다.
                    $('input[name="all"]').prop('checked', true);
                } else {
                    // 하나라도 선택되지 않은 상품 체크박스가 있을 경우, 전체 선택 체크박스의 선택을 해제합니다.
                    $('input[name="all"]').prop('checked', false);
                }
            });

        });

    </script>
</head>
<body>
<div id="wrapper">

    <main id="product">
        <!-- <aside>

         </aside>-->
        <section class="cart">
            <nav>
                <h1>장바구니</h1>

            </nav>
            <form id="yourFormId" action="#" th:action="@{/preparePayment}"
                  method="post">
                <table border="0">
                    <tr>
                        <th><input type="checkbox" name="all"></th>
                        <th>상품명</th>
                        <th>총수량</th>
                        <th>판매가</th>
                        <th>배송비</th>
                        <th>소계</th>
                    </tr>
                    <tr class="empty">
                        <td colspan="7">장바구니에 상품이 없습니다.</td>
                    </tr>
                    <!-- 장바구니 항목 표시 -->
                    <tr th:each="cartItem : ${cart.cartItems}">
                        <td><input type="checkbox" name="selectedItems" th:value="${cartItem.id}" class="item-checkbox">
                        </td>
                        <!--<td><input type="checkbox" name="1"></td>-->
                        <td>
                            <article>
                                <a href="#">
                                    <img th:src="${cartItem.product.mainImageUrl}">
                                </a>
                                <div>
                                    <h2 th:text="${cartItem.product.productName}"></h2>
                                    <p th:text="${cartItem.product.description}"></p>
                                </div>
                            </article>
                        </td>
                        <td>
                            <input type="number" th:value="${cartItem.quantity}" min="1" class="quantity-input"
                                   th:data-item-id="${cartItem.id}"/>
                        </td>
                        <td th:text="${cartItem.unitPrice}"></td>
                        <td>별도</td>
                        <td th:id="'subtotal-' + ${cartItem.id}" th:text="${cartItem.subTotal}"></td>

                    </tr>
                </table>
                <input type="button" name="del" value="선택삭제" onclick="deleteSelectedItems();">
                <div class="total">
                    <h2>전체합계</h2>
                    <table>
                        <!-- 전체합계 표시 -->
                        <tr>
                            <td>상품금액</td>
                            <td class="product-total-price" style="text-align: left;">0</td>
                        </tr>
                        <tr>
                            <td>배송비</td>
                            <td class="shipping-fee" th:text="${fee}"></td>
                            <input type="hidden" id="hiddenFeePrice" name="feePrice" th:value="${fee}">
                        </tr>
                        <tr>
                            <td>전체주문금액</td>
                            <td th:id="totalPrice" th:text="${cart.totalPrice + fee}"></td>
                            <input type="hidden" id="hiddenTotalPrice" name="totalPrice" value="0">
                        </tr>
                    </table>
                    <input type="submit" value="주문하기">
                </div>
            </form>
        </section>
    </main>
    <!--    <footer>
        </footer>-->
    <button type="button" id="top">상단이동</button>
</div>
</body>
</html>